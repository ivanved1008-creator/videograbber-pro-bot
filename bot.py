import asyncio
import logging
from telethon import TelegramClient, events

# ==================== –ù–ê–°–¢–†–û–ô–ö–ò ====================
# –í–ê–®–ò –î–ê–ù–ù–´–ï (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏)
API_ID = 36849897
API_HASH = '3b1f361c18993639ae7eab250eb51ab8'
BOT_TOKEN = '8550747360:AAF0nhq9CMRhVgplUSeP7JWCbCNqo3NkNXs'  # –¢–æ–∫–µ–Ω –í–ê–®–ï–ì–û –±–æ—Ç–∞ @videograbber_pro_bot

# –ë–û–¢-–ó–ê–ì–†–£–ó–ß–ò–ö (–º–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å, —Å–º. —Å–ø–∏—Å–æ–∫ –Ω–∏–∂–µ)
DOWNLOADER_BOT = '@GozillaDownloader'  # –û—Å–Ω–æ–≤–Ω–æ–π –±–æ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è

# –ò–º—è –¥–ª—è —Ñ–∞–π–ª–æ–≤ —Å–µ—Å—Å–∏–∏ (–º–æ–∂–Ω–æ –ª—é–±–æ–µ, –Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–∞—à –ª–æ–≥–∏–Ω –Ω–∞ —Ö–æ—Å—Ç–∏–Ω–≥–µ)
SESSION_NAME = 'ivan2'
# ==================================================

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∏–µ–Ω—Ç–æ–≤ Telethon
# user_client - –≤–∞—à –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–º
user_client = TelegramClient(f'{SESSION_NAME}_user.session', API_ID, API_HASH)
# bot_client - –≤–∞—à –±–æ—Ç –¥–ª—è –ø—Ä–∏–µ–º–∞ –∫–æ–º–∞–Ω–¥ –æ—Ç –ª—é–¥–µ–π
bot_client = TelegramClient(f'{SESSION_NAME}_bot.session', API_ID, API_HASH).start(bot_token=BOT_TOKEN)

logger.info("ü§ñ –ë–æ—Ç-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è...")

# ==================== –û–ë–†–ê–ë–û–¢–ö–ê –ö–û–ú–ê–ù–î ====================
@bot_client.on(events.NewMessage(pattern='/start'))
async def start_handler(event):
    """–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /start"""
    await event.reply(
        "üöÄ –ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –≤–∏–¥–µ–æ.\n"
        f"–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ —Å YouTube –∏–ª–∏ TikTok, –∏ —è –ø–µ—Ä–µ–¥–∞–º –µ—ë –∑–∞–≥—Ä—É–∑—á–∏–∫—É {DOWNLOADER_BOT}."
    )

@bot_client.on(events.NewMessage(pattern='/help'))
async def help_handler(event):
    """–û—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—É /help"""
    await event.reply(
        "üìñ **–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:**\n"
        "1. –°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É –Ω–∞ –≤–∏–¥–µ–æ (YouTube, TikTok –∏ –¥—Ä.)\n"
        "2. –û—Ç–ø—Ä–∞–≤—å —Å—Å—ã–ª–∫—É –º–Ω–µ\n"
        "3. –Ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–¥–∞–º –µ—ë –º–æ—â–Ω–æ–º—É –∑–∞–≥—Ä—É–∑—á–∏–∫—É\n"
        "4. –ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ–Ω –ø—Ä–∏—à–ª—ë—Ç –≤–∏–¥–µ–æ, —è —Å—Ä–∞–∑—É –ø–µ—Ä–µ—à–ª—é –µ–≥–æ —Ç–µ–±–µ!\n\n"
        "‚è≥ –û–±—ã—á–Ω–æ —ç—Ç–æ –∑–∞–Ω–∏–º–∞–µ—Ç –æ—Ç 15 –¥–æ 60 —Å–µ–∫—É–Ω–¥."
    )

# ==================== –û–°–ù–û–í–ù–ê–Ø –õ–û–ì–ò–ö–ê: –û–ë–†–ê–ë–û–¢–ö–ê –°–°–´–õ–û–ö ====================
@bot_client.on(events.NewMessage())
async def link_handler(event):
    """–ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Å—Å—ã–ª–∫—É –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–º."""
    user_msg = event.message.message
    user = await event.get_sender()

    # –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ —ç—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ —Å—Å—ã–ª–∫—É YouTube/TikTok
    if not ('youtu' in user_msg or 'tiktok' in user_msg):
        return  # –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º, –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ —Å—Å—ã–ª–∫–∞

    logger.info(f"üì• –ü–æ–ª—É—á–µ–Ω–∞ —Å—Å—ã–ª–∫–∞ –æ—Ç @{user.username}: {user_msg}")
    status_msg = await event.reply(f'üîÑ –ü–µ—Ä–µ–¥–∞—é —Å—Å—ã–ª–∫—É –∑–∞–≥—Ä—É–∑—á–∏–∫—É {DOWNLOADER_BOT}...')

    try:
        # –®–ê–ì 1: –í–∞—à –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å—Å—ã–ª–∫—É –±–æ—Ç—É-–∑–∞–≥—Ä—É–∑—á–∏–∫—É
        async with user_client:
            # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å—Å—ã–ª–∫—É
            sent_message = await user_client.send_message(DOWNLOADER_BOT, user_msg)
            logger.info(f"üì§ –°—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –∑–∞–≥—Ä—É–∑—á–∏–∫—É. ID –Ω–∞—à–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è: {sent_message.id}")
            
            # –î–∞–µ–º –≤—Ä–µ–º—è –±–æ—Ç—É-–∑–∞–≥—Ä—É–∑—á–∏–∫—É –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —Å—Å—ã–ª–∫—É (–º–æ–∂–Ω–æ —É–≤–µ–ª–∏—á–∏—Ç—å –¥–ª—è –±–æ–ª—å—à–∏—Ö –≤–∏–¥–µ–æ)
            await asyncio.sleep(35)
            logger.info("‚è≥ –ü–æ–∏—Å–∫ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫–∞...")

            # –®–ê–ì 2: –ò—â–µ–º –≤ —á–∞—Ç–µ —Å –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–º –æ—Ç–≤–µ—Ç (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 10 —Å–æ–æ–±—â–µ–Ω–∏–π)
            messages = await user_client.get_messages(DOWNLOADER_BOT, limit=10)
            logger.info(f"üì® –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ {len(messages)} —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫–∞.")

            for msg in messages:
                # –ò—â–µ–º –≤–∏–¥–µ–æ –∏–ª–∏ –¥–æ–∫—É–º–µ–Ω—Ç, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—à–µ–ª –ü–û–°–õ–ï –Ω–∞—à–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞
                if msg.id > sent_message.id and (msg.video or (msg.document and 'video' in str(msg.document.mime_type))):
                    logger.info(f"‚úÖ –ù–∞–π–¥–µ–Ω–æ –≤–∏–¥–µ–æ –¥–ª—è –ø–µ—Ä–µ—Å—ã–ª–∫–∏: {msg.file.name if msg.file else '–≤–∏–¥–µ–æ-—Ñ–∞–π–ª'}")

                    # –®–ê–ì 3: –ù–∞—à–ª–∏ –≤–∏–¥–µ–æ! –ü–µ—Ä–µ—Å—ã–ª–∞–µ–º –µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.
                    await status_msg.edit_text('‚úÖ –í–∏–¥–µ–æ –≥–æ—Ç–æ–≤–æ! –û—Ç–ø—Ä–∞–≤–ª—è—é...')
                    await user_client.forward_messages(user.id, msg)
                    logger.info(f"üì≠ –í–∏–¥–µ–æ –ø–µ—Ä–µ—Å–ª–∞–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user.id}.")
                    return  # –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

            # –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞, –∑–Ω–∞—á–∏—Ç, –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ñ–∞–π–ª –Ω–µ –Ω–∞—à–µ–ª—Å—è
            logger.warning("‚ùå –ó–∞–≥—Ä—É–∑—á–∏–∫ –Ω–µ –≤–µ—Ä–Ω—É–ª –≤–∏–¥–µ–æ—Ñ–∞–π–ª –≤ –æ—Ç–≤–µ–¥–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è.")
            await status_msg.edit_text(
                '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≤–∏–¥–µ–æ –æ—Ç –∑–∞–≥—Ä—É–∑—á–∏–∫–∞.\n'
                '–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã:\n'
                '‚Ä¢ –ó–∞–≥—Ä—É–∑—á–∏–∫ –ø–µ—Ä–µ–≥—Ä—É–∂–µ–Ω\n'
                '‚Ä¢ –°—Å—ã–ª–∫–∞ –Ω–µ—Ä–∞–±–æ—á–∞—è –∏–ª–∏ –ø—Ä–∏–≤–∞—Ç–Ω–∞—è\n'
                '‚Ä¢ –ó–∞–≥—Ä—É–∑—á–∏–∫ –∏–∑–º–µ–Ω–∏–ª –ª–æ–≥–∏–∫—É —Ä–∞–±–æ—Ç—ã\n'
                '–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥—É—é —Å—Å—ã–ª–∫—É –∏–ª–∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.'
            )

    except Exception as e:
        # –õ–æ–≤–∏–º –ª—é–±—ã–µ –æ—à–∏–±–∫–∏ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ
        logger.error(f"üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –≤ —Ä–∞–±–æ—Ç–µ —Å –∑–∞–≥—Ä—É–∑—á–∏–∫–æ–º: {e}", exc_info=True)
        await status_msg.edit_text(f'‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞: {str(e)[:150]}')

# ==================== –ó–ê–ü–£–°–ö –ë–û–¢–ê ====================
async def main():
    """–ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –≤—Å–µ—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤."""
    # –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –≤–∞—à –ª–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç (–ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –∑–∞–ø—Ä–æ—Å–∏—Ç –Ω–æ–º–µ—Ä –∏ –∫–æ–¥)
    await user_client.start()
    logger.info("‚úÖ –õ–∏—á–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω.")
    # –ó–∞–ø—É—Å–∫–∞–µ–º –≤–∞—à–µ–≥–æ –±–æ—Ç–∞
    await bot_client.start()
    me = await bot_client.get_me()
    logger.info(f"üéâ –ë–æ—Ç-–ø–æ—Å—Ä–µ–¥–Ω–∏–∫ @{me.username} –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è!")
    # –ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    await bot_client.run_until_disconnected()
    
import sys

if __name__ == '__main__':
    # –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏ —É—Å—Ç–æ–π—á–∏–≤—ã–π —Å–ø–æ—Å–æ–± –∑–∞–ø—É—Å–∫–∞ –¥–ª—è —Ö–æ—Å—Ç–∏–Ω–≥–æ–≤
    loop = asyncio.new_event_loop()
    asyncio.set_event_loop(loop)
    
    try:
        # –°–æ–∑–¥–∞–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –æ—Å–Ω–æ–≤–Ω—É—é –∑–∞–¥–∞—á—É
        main_task = loop.create_task(main())
        loop.run_until_complete(main_task)
    except KeyboardInterrupt:
        logger.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è (Ctrl+C). –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ...")
    except Exception as e:
        logger.error(f"–ù–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω–æ–µ –∏—Å–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ: {e}", exc_info=True)
        sys.exit(1)
    finally:
        # –í—Å–µ–≥–¥–∞ —Å—Ç–∞—Ä–∞–µ–º—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Ü–∏–∫–ª —Å–æ–±—ã—Ç–∏–π
        logger.info("–ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞...")
        try:
            # –û—Ç–º–µ–Ω—è–µ–º –≤—Å–µ –∑–∞–¥–∞—á–∏
            pending = asyncio.all_tasks(loop)
            for task in pending:
                task.cancel()
            # –î–∞–µ–º –∑–∞–¥–∞—á–∞–º –≤—Ä–µ–º—è –Ω–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
            loop.run_until_complete(asyncio.gather(*pending, return_exceptions=True))
            loop.run_until_complete(loop.shutdown_asyncgens())
        finally:
            loop.close()
            logger.info("–¶–∏–∫–ª —Å–æ–±—ã—Ç–∏–π –∑–∞–∫—Ä—ã—Ç. –í—ã—Ö–æ–¥.")
